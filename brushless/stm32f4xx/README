> Copyright (C) 2019  Adrien Boussicault <adrien.boussicault@labri.fr>
>
> This program is free software: you can redistribute it and/or
> modify it under the terms of the GNU Lesser General Public
> License as published by the Free Software Foundation, either
> version 3 of the License, or (at your option) any later version.
>
> This program is distributed in the hope that it will be useful,
> but WITHOUT ANY WARRANTY; without even the implied warranty of
> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
> Lesser General Public License for more details.
>
> You should have received a copy of the GNU Lesser General Public
> License along with this program.  If not, see
> <http://www.gnu.org/licenses/>.

This documentation explains how to compile the firmware of the brushless 
board, and how to flash the brushless board, by using a Linux Operating System.


##################
# Installation : #
##################

Installation commands are for Debian or Ubuntu.

Install the following package :
-------------------------------

sudo apt-get install dfu-util cu build-essential python-serial r-base

Install R libraries : 
---------------------

./tools/logs/install.r

Uninstall the modemmanager : 
----------------------------

sudo apt-get remove modemmanager

( The modemManger will grab the serial line of the USB : /dev/ttyACM0;
if you are using this service, you should prefer do desactivate them with the
following command : systemctl stop ModemManager.service )

Add Udev permition to have an access to /dev/ttyACMO
----------------------------------------------------

sudo adduser USER plugdev
sudo adduser USER dialout

Add/edit the file /etc/udev/rules.d/42-cycloide.rules and add the following 
lines :

ATTRS{idProduct}=="4567", ATTRS{idVendor}=="f123", MODE="664", GROUP="plugdev" SYMLINK+="brushless"
ATTRS{idProduct}=="5740", ATTRS{idVendor}=="0483", MODE="664", GROUP="plugdev" SYMLINK+="stm32"

The first line is dedicated to comunicate with the brushless when the firmware
is yet loaded in the board. The second one is used to flash the firmware.

Restart the udev service :
 
sudo /etc/init.d/udev restart

Normally, all should works but if you enconter some problem in the next sections, restart your computer.

Download ans install the last ARM compiler :
--------------------------------------------------

We use the gcc-arm-none-eabi compiler. You can download it at :

https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads

Install the compiler in the root directory of the project.

You can install the compiler in another directory. In this case, 
we will explain you, in all the next sections, how to adapt the commands.

Normally, the project should looks like :
<root_directory>
├── Core
├── gcc-arm-none-eabi-XXXXXXXXX
│   ├── bin
│   ...
├── Makefile
...


Download the CMSIS source code :
--------------------------------

Install the CMSIS library in the root directory by typing :

git clone https://github.com/ARM-software/CMSIS_5.git CMSIS_5

You can install the compiler in another directory. In this case, 
we will explain you, in all the next sections, how to adapt the commands.

Normally, the project should looks like :
<root_directory>
├── Core
├── CMSIS_5
│   ├── CMSIS
│   ...
├── Makefile
...


OPTIONAL INSTALLATION (to use JTAG):
-------------------------------------

You can install JLink tools in order to use JTAG to flash or print.
Go to the website :  

https://www.segger.com/downloads/jlink/

And install the J-Link Software and Documentation Pack :
    - download the debian package (file finishing with .deb)
    - install it : sudo dpkg --install XXX.deb
      where XXX.deb is the name downloaded file.

OPTIONAL INSTALLAION OF CUBEMX (to update the source code autgenerated by cubeMX ):
-----------------------------------------------------------------------------------

If you want to change the configuration generated by CUBEMX, you have to install
CubeMX for the following website :

https://www.st.com/en/development-tools/stm32cubemx.html

#########################################
# Compile the application               #
#########################################

Just type

make


If you have installed GCC and CMSIS in an unusual place, then you have to type :

make GCC_PATH=<ARM_DIRECTORY>/bin CMSIS_PATH=<CMSIS_5_PATH>/CMSIS

otherwise, you just have to add two symbolic links in your root directory :

cd <root directory>
ln -s ARM_DIRECTIRY gcc-arm-none-eabi
ln -s CMSIS_5_DIRECTIRY CMSIS_5

###################
# Flash the board #
###################

Three solutions are possible depending of the situation.
IF THE BOARD HAVE NOT YET BEEN FLASHED, YOU SHOULD USE (as you want) SOLUTION 
1) OR 2).
Solution 3) is the most simple one and it is used to update the firmware (we 
need the board to be yet flashed).

Short description of the 3 solutions : 
 1) FLASH BY USB USING THE RESET AND BOOT0 BUTTONS
   This solution doesn't need the board to be yet flashed.
   This solution need USB wire and and an access to the BOOT0 and RESET buttons
   of the board.
 2) FLASH BY JTAG USING THE JLink SOFWTARE
   This solution doesn't need the board to be yet flashed.
   This solution need an USB wire (for the power) and a JTAG for the connection.
   This solution Use JLink software (see Optional installation)
   The JLink software downloads just the part of the memory that have changed.
   So the flash operation are fast and the life of the flash memory is 
   increased.
 3) FLASH BY USB WITHOUT USING THE RESET BUTTONS
   This solution need the board to be yet flashed
   ( by using 1) or 2) for example ).
   This solution just need a USB wire ! :)
   This solution DO NOT require an acess to the BOOT0 and RESET button ! :)


1) FLASH BY USB USING THE RESET AND BOOT0 BUTTONS

 Connect the USB wire.

 Press and hold the BOOT0 button, then press and realease de RESET button,
 and finally release the BOOT0 button.

 Type the command :
 ./first_flash_with_usb_and_reset_button.sh

2) FLASH BY JTAG USING THE JLink SOFWTARE

 ./jtag_flash.sh

3) FLASH BY USB WITHOUT THE RESET BUTTONS

 ./usb_flash.sh

########################
# Connect to the board #
########################

First Connect the USB wire.

To know on which device the board is connected (usualy it is /dev/ttyACM0),
you have to execute the following command :

dmesg

The output should looks like : 

   [112520.828609] usb 1-5: new full-speed USB device number 59 using xhci_hcd
   [112520.979771] usb 1-5: New USB device found, idVendor=f123, idProduct=4567, bcdDevice= 2.00
   [112520.979777] usb 1-5: New USB device strings: Mfr=1, Product=2, SerialNumber=3
   [112520.979780] usb 1-5: Product: Brushless Driver
   [112520.979783] usb 1-5: Manufacturer: OpenHandicap
   [112520.979785] usb 1-5: SerialNumber: 346F398B3038
   [112520.981964] cdc_acm 1-5:1.0: ttyACM0: USB ACM device

and the serial port is ttyACM0, so the device is connected on (/def/ttyACM0).

Open a command line into the board by typing:

cu -l /dev/ttyACM0

Your are connected to the boare. Enjoy :) 
(In the command line, help is the first helpfull command to know)
(type 'led' to turn on/off the led of the board) 


OPTIONAL :
----------
Some informations are sent using the jtag link. (just some small messages 
to prevent warnings and errors). Those messages appear in the terminal too.

If you want to read the jtag output, you need to install JLink (see the
optional section on JTag), and then, you just have to type : 

./print_jtag

Jtag is usefull for developpers.
